# Поднимаем инстанс эластика

docker-compose

    version: "3"

    services:
    elastic-search:
        image: elasticsearch:8.7.1
        ports:
        - 9200:9200
        networks:
        - elastic-net

    networks:
        elastic-net:


сбрасываем пароль для пользователя по умолчанию

    d.yakovlev@MacBook-Pro-X5 otus % docker exec -it hw7-elastic-search-1 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
    WARNING: Owner of file [/usr/share/elasticsearch/config/users] used to be [root], but now is [elasticsearch]
    WARNING: Owner of file [/usr/share/elasticsearch/config/users_roles] used to be [root], but now is [elasticsearch]
    This tool will reset the password of the [elastic] user to an autogenerated value.
    The password will be printed in the console.
    Please confirm that you would like to continue [y/N]y


    Password for the [elastic] user successfully reset.
    New value: W04ARe6b4wkzKU1hyehk


Проверяем что все ок

    d.yakovlev@MacBook-Pro-X5 HW7 % curl --cacert http_ca.crt -u elastic https://localhost:9200                         
    Enter host password for user 'elastic':
    {
        "name" : "2e69037a05ec",
        "cluster_name" : "docker-cluster",
        "cluster_uuid" : "PVyriJXRQrivSvMru1KuMw",
        "version" : {
            "number" : "8.7.1",
            "build_flavor" : "default",
            "build_type" : "docker",
            "build_hash" : "f229ed3f893a515d590d0f39b05f68913e2d9b53",
            "build_date" : "2023-04-27T04:33:42.127815583Z",
            "build_snapshot" : false,
            "lucene_version" : "9.5.0",
            "minimum_wire_compatibility_version" : "7.17.0",
            "minimum_index_compatibility_version" : "7.0.0"
        },
        "tagline" : "You Know, for Search"
    }

## Простые запросы 

Создадим индекс

    PUT https://localhost:9200/my-first-index

    {
        "acknowledged": true,
        "shards_acknowledged": true,
        "index": "my-first-index"
    }

Получим информацию по индексу

    GET https://localhost:9200/my-first-index

    {
        "my-first-index": {
            "aliases": {},
            "mappings": {},
            "settings": {
                "index": {
                    "routing": {
                        "allocation": {
                            "include": {
                                "_tier_preference": "data_content"
                            }
                        }
                    },
                    "number_of_shards": "1",
                    "provided_name": "my-first-index",
                    "creation_date": "1684767826679",
                    "number_of_replicas": "1",
                    "uuid": "j8n4KjyxQCGef8-wCIOwEA",
                    "version": {
                        "created": "8070199"
                    }
                }
            }
        }
    }

Запишем документ в индекс c помощью _doc

    POST https://localhost:9200/my-first-index/_doc

    {
        "name":"Dmitiry",
        "surname":"Yakovlev",
        "documents":{
            "passport":{
                "series": "1122",
                "number": "123456"
            },
            "inn": "1234567890"
        }
    }

    {
        "_index": "my-first-index",
        "_id": "xBkBRIgB5NCi_lihKS5f",
        "_version": 1,
        "result": "created",
        "_shards": {
            "total": 2,
            "successful": 1,
            "failed": 0
        },
        "_seq_no": 0,
        "_primary_term": 1
    }

Получим документ обратно

    GET https://localhost:9200/my-first-index/_doc/xBkBRIgB5NCi_lihKS5f

    {
        "_index": "my-first-index",
        "_id": "xBkBRIgB5NCi_lihKS5f",
        "_version": 1,
        "_seq_no": 0,
        "_primary_term": 1,
        "found": true,
        "_source": {
            "name": "Dmitiry",
            "surname": "Yakovlev",
            "documents": {
                "passport": {
                    "series": "1122",
                    "number": "123456"
                },
                "inn": "1234567890"
            }
        }
    }

Теперь запросим только source

    GET https://localhost:9200/my-first-index/_source/xBkBRIgB5NCi_lihKS5f

    {
        "name": "Dmitiry",
        "surname": "Yakovlev",
        "documents": {
            "passport": {
                "series": "1122",
                "number": "123456"
            },
            "inn": "1234567890"
        }
    }

Теперь создадим документ с "ручным" id

    POST https://localhost:9200/my-first-index/_create/123

    {
        "_index": "my-first-index",
        "_id": "123",
        "_version": 1,
        "result": "created",
        "_shards": {
            "total": 2,
            "successful": 1,
            "failed": 0
        },
        "_seq_no": 1,
        "_primary_term": 1
    }

И запросим его 

    GET https://localhost:9200/my-first-index/_source/123

    {
        "name": "John",
        "surname": "Doe",
        "documents": {
            "inn": "1234567890",
            "snils": "123-123-123",
            "driving-license": {
                "series": "1234",
                "number": "123456"
            }
        }
    }

Обновим имя в первом созданном документе

    POST https://localhost:9200/my-first-index/_update/xBkBRIgB5NCi_lihKS5f

    {
        "doc":{
            "name": "Dmitriy"
        }
    }

    {
        "_index": "my-first-index",
        "_id": "xBkBRIgB5NCi_lihKS5f",
        "_version": 2,
        "result": "updated",
        "_shards": {
            "total": 2,
            "successful": 1,
            "failed": 0
        },
        "_seq_no": 2,
        "_primary_term": 1
    }

Проверим, что обновилось

    GET https://localhost:9200/my-first-index/_source/xBkBRIgB5NCi_lihKS5f

    {
        "name": "Dmitriy",
        "surname": "Yakovlev",
        "documents": {
            "passport": {
                "series": "1122",
                "number": "123456"
            },
            "inn": "1234567890"
        }
    }


Попробуем добавить целое поле

    POST https://localhost:9200/my-first-index/_update/123

    {
        "doc":{
            "documents": {
                "passport": {
                    "series": "1234",
                    "number": "654321"
                }
            }
        }
    }

    {
        "name": "John",
        "surname": "Doe",
        "documents": {
            "inn": "1234567890",
            "snils": "123-123-123",
            "driving-license": {
                "series": "1234",
                "number": "123456"
            },
            "passport": {
                "number": "654321",
                "series": "1234"
            }
        }
    }


## Поисковые запросы

Cоздаем индекс fuzzy-search с маппингом и настройками для поиска на русском языке

    PUT https://localhost:9200/fuzzy-search

    {
        "mappings":{
            "properties": {
                "phrase": { "type": "text"}
            }
        },
        "settings": {
            "analysis": {
                "filter": {
                    "russian_stop": {
                        "type":       "stop",
                        "stopwords":  "_russian_" 
                    },
                    "russian_stemmer": {
                        "type":       "stemmer",
                        "language":   "russian"
                    }
                },
                "analyzer": {
                    "my_russian": {
                        "tokenizer":  "standard",
                        "filter": [
                            "lowercase",
                            "russian_stop",
                            "russian_stemmer"
                        ]
                    }
                }
            }
        } 
    }

Вставляем документы 

    POST https://localhost:9200/fuzzy-search/_bulk

    {"create":{"_index":"fuzzy-search","_id":"1"}}
    {"phrase":"моя мама мыла посуду а кот жевал сосиски"}
    {"create":{"_index":"fuzzy-search","_id":"2"}}
    {"phrase":"рама была отмыта и вылизана котом"}
    {"create":{"_index":"fuzzy-search","_id":"3"}}
    {"phrase":"мама мыла раму"}

Делаем запрос нечеткого поиска

    GET https://localhost:9200/fuzzy-search/_search

    {
        "query":{
            "match":{
                "phrase":{
                    "query":"мама ела сосиски",
                    "fuzziness":"auto"
                }
            }
        }
    }

Получаем ответ

    {
        "took": 10,
        "timed_out": false,
        "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
        },
        "hits": {
            "total": {
                "value": 3,
                "relation": "eq"
            },
            "max_score": 1.241674,
            "hits": [
                {
                    "_index": "fuzzy-search",
                    "_id": "1",
                    "_score": 1.241674,
                    "_source": {
                        "phrase": "моя мама мыла посуду а кот жевал сосиски"
                    }
                },
                {
                    "_index": "fuzzy-search",
                    "_id": "3",
                    "_score": 0.5820575,
                    "_source": {
                        "phrase": "мама мыла раму"
                    }
                },
                {
                    "_index": "fuzzy-search",
                    "_id": "2",
                    "_score": 0.34421936,
                    "_source": {
                        "phrase": "рама была отмыта и вылизана котом"
                    }
                }
            ]
        }
    }


Найдены все документы
- У документа с фразой "моя мама мыла посуду а кот жевал сосиски" самый большой скор, потому что есть слова "мама" и "сосиски" в неизменном виде, относительно поискового запроса.
- На втором месте документ с фразой "мама мыла раму", потому что есть неизменное слово "мама"
- На третьем месте "рама была отмыта и вылизана котом", потому что есть слово "рама", которое очень близко к слову "мама", поэтому эластик выдает его в поисковой выдаче